{% extends "base.html" %}

{% block title %}
    {% if message %}Edit Message{% else %}New Message{% endif %} - BLE UART Protocol Testing Harness
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="fas fa-{% if message %}edit{% else %}plus{% endif %} me-2"></i>
                {% if message %}Edit Message{% else %}New Message{% endif %}
            </h1>
            <a href="/messages" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to Messages
            </a>
        </div>

        <div class="card">
            <div class="card-body">
                <form method="POST" id="messageForm" action="{% if message %}/messages/{{ message.id }}{% else %}/messages{% endif %}">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="message_type_id" class="form-label">Message Type *</label>
                            <select class="form-select" id="message_type_id" name="message_type_id" required 
                                    onchange="loadMessageTypeAttributes()">
                                <option value="">Select a message type...</option>
                                {% for msg_type in message_types.values() %}
                                <option value="{{ msg_type.id }}" 
                                        {% if message and message.message_type_id == msg_type.id %}selected{% endif %}>
                                    {{ msg_type.name }} - {{ msg_type.description or 'No description' }}
                                </option>
                                {% endfor %}
                            </select>
                            <div class="form-text">Choose the message type that defines the structure of this message</div>
                        </div>
                        <div class="col-md-6">
                            <label for="name" class="form-label">Message Name *</label>
                            <input type="text" class="form-control" id="name" name="name" 
                                   value="{{ message.name if message else '' }}" required>
                            <div class="form-text">A descriptive name for this message instance</div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-12">
                            <label for="description" class="form-label">Description</label>
                            <input type="text" class="form-control" id="description" name="description" 
                                   value="{{ message.description if message else '' }}">
                            <div class="form-text">Optional description of what this message is used for</div>
                        </div>
                    </div>

                    <hr class="my-4">

                    <div id="attributesSection" style="display: none;">
                        <h5><i class="fas fa-list me-2"></i>Attribute Values</h5>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Note:</strong> Fill in the values for each attribute. Leave empty to use default values if available.
                        </div>

                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Attribute</th>
                                        <th>Width</th>
                                        <th>Type</th>
                                        <th>Default Value</th>
                                        <th>Value</th>
                                        <th>Description</th>
                                    </tr>
                                </thead>
                                <tbody id="attributesContainer">
                                    <!-- Attributes will be dynamically loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                        <a href="/messages" class="btn btn-secondary me-md-2">Cancel</a>
                        <button type="submit" class="btn btn-primary" id="submitBtn" disabled>
                            <i class="fas fa-save me-2"></i>
                            {% if message %}Update{% else %}Create{% endif %} Message
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentMessageType = null;
let currentAttributes = [];

function loadMessageTypeAttributes() {
    const messageTypeSelect = document.getElementById('message_type_id');
    const messageTypeId = messageTypeSelect.value;
    const attributesSection = document.getElementById('attributesSection');
    const submitBtn = document.getElementById('submitBtn');
    
    if (!messageTypeId) {
        attributesSection.style.display = 'none';
        submitBtn.disabled = true;
        return;
    }
    
    // Find the selected message type
    const messageTypes = {{ message_types | tojson }};
    currentMessageType = messageTypes[messageTypeId];
    
    if (!currentMessageType) {
        attributesSection.style.display = 'none';
        submitBtn.disabled = true;
        return;
    }
    
    // Load attributes
    loadAttributes(currentMessageType.attributes);
    attributesSection.style.display = 'block';
    submitBtn.disabled = false;
}

function loadAttributes(attributes) {
    const container = document.getElementById('attributesContainer');
    container.innerHTML = '';
    currentAttributes = attributes;
    
    attributes.forEach((attr, index) => {
        const row = document.createElement('tr');
        
        // Get current value if editing
        let currentValue = '';
        if ({{ 'true' if message else 'false' }} && {{ message.values | tojson if message else '{}' }}[attr.name]) {
            currentValue = {{ message.values | tojson if message else '{}' }}[attr.name];
        }
        
        row.innerHTML = `
            <td>
                <strong>${attr.name}</strong>
                ${attr.is_computed ? '<i class="fas fa-calculator ms-1 text-info" title="Computed"></i>' : ''}
            </td>
            <td>
                ${attr.width ? (attr.is_max_width ? `â‰¤${attr.width}` : attr.width) : 'Variable'}
            </td>
            <td>
                ${attr.is_max_width ? 'Max Width' : 'Fixed Width'}
            </td>
            <td>
                ${attr.default_value ? `<code>${attr.default_value}</code>` : '<span class="text-muted">None</span>'}
            </td>
            <td>
                <input type="text" class="form-control form-control-sm" 
                       name="attribute_value_${attr.name}" 
                       value="${currentValue}"
                       placeholder="${attr.default_value || 'Enter value'}"
                       ${attr.is_computed ? 'readonly' : ''}>
            </td>
            <td>
                <small class="text-muted">${attr.description || 'No description'}</small>
            </td>
        `;
        
        container.appendChild(row);
    });
}

// Initialize form if editing
document.addEventListener('DOMContentLoaded', function() {
    {% if message %}
        // If editing, load the attributes for the current message type
        loadMessageTypeAttributes();
    {% endif %}
});

// Form validation
document.getElementById('messageForm').addEventListener('submit', function(e) {
    const messageTypeId = document.getElementById('message_type_id').value;
    const name = document.getElementById('name').value.trim();
    
    if (!messageTypeId) {
        alert('Please select a message type.');
        e.preventDefault();
        return;
    }
    
    if (!name) {
        alert('Please enter a message name.');
        e.preventDefault();
        return;
    }
    
    // Validate that required attributes have values
    let hasError = false;
    currentAttributes.forEach(attr => {
        if (!attr.is_computed) {
            const valueInput = document.querySelector(`input[name="attribute_value_${attr.name}"]`);
            if (valueInput && !valueInput.value.trim() && !attr.default_value) {
                alert(`Attribute "${attr.name}" requires a value.`);
                hasError = true;
                return;
            }
        }
    });
    
    if (hasError) {
        e.preventDefault();
    }
});
</script>
{% endblock %}
