{% extends "base.html" %}

{% block title %}
    {% if sequence %}Edit Message Sequence{% else %}New Message Sequence{% endif %} - BLE UART Protocol Testing Harness
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="fas fa-{% if sequence %}edit{% else %}plus{% endif %} me-2"></i>
                {% if sequence %}Edit Message Sequence{% else %}New Message Sequence{% endif %}
            </h1>
            <a href="/message-sequences" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to Sequences
            </a>
        </div>

        <div class="card">
            <div class="card-body">
                <form method="POST" id="sequenceForm" action="{% if sequence %}/message-sequences/{{ sequence.id }}{% else %}/message-sequences{% endif %}">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="name" class="form-label">Sequence Name *</label>
                            <input type="text" class="form-control" id="name" name="name" 
                                   value="{{ sequence.name if sequence else '' }}" required>
                            <div class="form-text">A descriptive name for this message sequence</div>
                        </div>
                        <div class="col-md-6">
                            <label for="description" class="form-label">Description</label>
                            <input type="text" class="form-control" id="description" name="description" 
                                   value="{{ sequence.description if sequence else '' }}">
                            <div class="form-text">Optional description of what this sequence is used for</div>
                        </div>
                    </div>

                    <hr class="my-4">

                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5><i class="fas fa-list me-2"></i>Messages in Sequence</h5>
                        <button type="button" class="btn btn-success btn-sm" onclick="addMessageToSequence()">
                            <i class="fas fa-plus me-2"></i>Add Message
                        </button>
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Note:</strong> Add messages to your sequence and specify delays between them. 
                        Delays are in milliseconds (1000ms = 1 second).
                    </div>

                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Order</th>
                                    <th>Message</th>
                                    <th>Delay (ms)</th>
                                    <th>Message Type</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="sequenceContainer">
                                <!-- Messages will be dynamically added here -->
                            </tbody>
                        </table>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                        <a href="/message-sequences" class="btn btn-secondary me-md-2">Cancel</a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>
                            {% if sequence %}Update{% else %}Create{% endif %} Sequence
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let sequenceCounter = 0;
let availableMessages = {{ messages | tojson }};

// Initialize sequence on page load
document.addEventListener('DOMContentLoaded', function() {
    {% if sequence %}
        // Load existing messages for editing
        {% for msg_info in sequence.messages %}
            addMessageToSequence(
                '{{ msg_info.message_id }}',
                {{ msg_info.delay_ms }}
            );
        {% endfor %}
    {% endif %}
});

function addMessageToSequence(messageId = '', delay = 1000) {
    const container = document.getElementById('sequenceContainer');
    const sequenceRow = document.createElement('tr');
    sequenceRow.className = 'sequence-row';
    sequenceRow.id = `sequence-${sequenceCounter}`;
    
    // Find the message details
    let messageName = 'Select Message';
    let messageTypeName = '';
    if (messageId && availableMessages[messageId]) {
        messageName = availableMessages[messageId].name;
        // We'll need to get message type name from the backend or pass it through
    }
    
    sequenceRow.innerHTML = `
        <td>
            <span class="badge bg-secondary">${sequenceCounter + 1}</span>
        </td>
        <td>
            <select class="form-select form-select-sm" name="message_ids" required onchange="updateMessageInfo(${sequenceCounter})">
                <option value="">Select a message...</option>
                {% for msg in messages.values() %}
                <option value="{{ msg.id }}" 
                        data-name="{{ msg.name }}"
                        data-type="{{ msg.message_type_id }}"
                        ${messageId === '{{ msg.id }}' ? 'selected' : ''}>
                    {{ msg.name }} ({{ msg.id }})
                </option>
                {% endfor %}
            </select>
        </td>
        <td>
            <input type="number" class="form-control form-control-sm" name="delays" 
                   value="${delay}" min="0" step="100">
            <small class="text-muted">ms</small>
        </td>
        <td>
            <span class="message-type-info text-muted">-</span>
        </td>
        <td class="text-center">
            <div class="btn-group btn-group-sm">
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="moveMessage(${sequenceCounter}, -1)" title="Move Up">
                    <i class="fas fa-chevron-up"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="moveMessage(${sequenceCounter}, 1)" title="Move Down">
                    <i class="fas fa-chevron-down"></i>
                </button>
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeMessage(${sequenceCounter})" title="Remove">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </td>
    `;
    
    container.appendChild(sequenceRow);
    sequenceCounter++;
    
    // Update message info for the newly added row
    if (messageId) {
        updateMessageInfo(sequenceCounter - 1);
    }
}

function removeMessage(index) {
    const element = document.getElementById(`sequence-${index}`);
    if (element) {
        element.remove();
        updateOrderNumbers();
    }
}

function moveMessage(index, direction) {
    const container = document.getElementById('sequenceContainer');
    const currentRow = document.getElementById(`sequence-${index}`);
    const allRows = container.querySelectorAll('.sequence-row');
    
    if (!currentRow) return;
    
    const currentIndex = Array.from(allRows).indexOf(currentRow);
    const newIndex = currentIndex + direction;
    
    // Check bounds
    if (newIndex < 0 || newIndex >= allRows.length) return;
    
    // Swap the rows
    if (direction < 0) {
        // Moving up
        container.insertBefore(currentRow, allRows[newIndex]);
    } else {
        // Moving down
        const nextRow = allRows[newIndex + 1];
        if (nextRow) {
            container.insertBefore(currentRow, nextRow);
        } else {
            container.appendChild(currentRow);
        }
    }
    
    updateOrderNumbers();
}

function updateOrderNumbers() {
    const container = document.getElementById('sequenceContainer');
    const allRows = container.querySelectorAll('.sequence-row');
    
    allRows.forEach((row, newIndex) => {
        const oldId = row.id;
        const newId = `sequence-${newIndex}`;
        
        // Update the row ID
        row.id = newId;
        
        // Update the order number
        const orderBadge = row.querySelector('.badge');
        if (orderBadge) {
            orderBadge.textContent = newIndex + 1;
        }
        
        // Update all onclick handlers in the row
        const upButton = row.querySelector('button[onclick*="moveMessage"]');
        const downButton = row.querySelector('button[onclick*="moveMessage"]:nth-of-type(2)');
        const removeButton = row.querySelector('button[onclick*="removeMessage"]');
        
        if (upButton) {
            upButton.onclick = () => moveMessage(newIndex, -1);
        }
        if (downButton) {
            downButton.onclick = () => moveMessage(newIndex, 1);
        }
        if (removeButton) {
            removeButton.onclick = () => removeMessage(newIndex);
        }
        
        // Update message info update handler
        const select = row.querySelector('select');
        if (select) {
            select.onchange = () => updateMessageInfo(newIndex);
        }
    });
}

function updateMessageInfo(index) {
    const row = document.getElementById(`sequence-${index}`);
    if (!row) return;
    
    const select = row.querySelector('select');
    const messageTypeInfo = row.querySelector('.message-type-info');
    
    if (select && messageTypeInfo) {
        const selectedOption = select.options[select.selectedIndex];
        if (selectedOption && selectedOption.value) {
            const messageTypeId = selectedOption.getAttribute('data-type');
            // We could fetch message type names here, but for now just show the ID
            messageTypeInfo.textContent = messageTypeId || 'Unknown';
        } else {
            messageTypeInfo.textContent = '-';
        }
    }
}

// Form validation
document.getElementById('sequenceForm').addEventListener('submit', function(e) {
    const messages = document.querySelectorAll('.sequence-row');
    
    if (messages.length === 0) {
        alert('At least one message is required in the sequence.');
        e.preventDefault();
        return;
    }
    
    // Validate each message selection
    let hasError = false;
    messages.forEach((msg, index) => {
        const select = msg.querySelector('select[name="message_ids"]');
        if (!select.value) {
            alert(`Message ${index + 1} must have a message selected.`);
            hasError = true;
            return;
        }
    });
    
    if (hasError) {
        e.preventDefault();
    }
});
</script>
{% endblock %}
