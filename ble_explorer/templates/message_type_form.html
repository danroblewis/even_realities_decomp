{% extends "base.html" %}

{% block title %}
    {% if message_type %}Edit Message Type{% else %}New Message Type{% endif %} - BLE UART Protocol Testing Harness
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="fas fa-{% if message_type %}edit{% else %}plus{% endif %} me-2"></i>
                {% if message_type %}Edit Message Type{% else %}New Message Type{% endif %}
            </h1>
            <a href="/" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to List
            </a>
        </div>

        <div class="card">
            <div class="card-body">
                <form method="POST" id="messageTypeForm" action="{% if message_type %}/message-types/{{ message_type.id }}{% else %}/message-types{% endif %}">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="name" class="form-label">Message Type Name *</label>
                            <input type="text" class="form-control" id="name" name="name" 
                                   value="{{ message_type.name if message_type else '' }}" required>
                            <div class="form-text">A descriptive name for this message type (e.g., "Data Request", "Status Update")</div>
                        </div>
                        <div class="col-md-6">
                            <label for="description" class="form-label">Description</label>
                            <input type="text" class="form-control" id="description" name="description" 
                                   value="{{ message_type.description if message_type else '' }}">
                            <div class="form-text">Optional description of what this message type is used for</div>
                        </div>
                    </div>

                    <hr class="my-4">

                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5><i class="fas fa-list me-2"></i>Attributes</h5>
                        <button type="button" class="btn btn-success btn-sm" onclick="addAttribute()">
                            <i class="fas fa-plus me-2"></i>Add Attribute
                        </button>
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Note:</strong> The first attribute is always "command" and cannot be removed. 
                        Use "width" for the size value and check "Is Max Width" if it represents a maximum width rather than a fixed width.
                    </div>

                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Name</th>
                                    <th>Width</th>
                                    <th>Is Max Width</th>
                                    <th>Description</th>
                                    <th>Default Value</th>
                                    <th>Computed</th>
                                    <th>Computed From</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="attributesContainer">
                                <!-- Attributes will be dynamically added here -->
                            </tbody>
                        </table>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                        <a href="/" class="btn btn-secondary me-md-2">Cancel</a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>
                            {% if message_type %}Update{% else %}Create{% endif %} Message Type
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let attributeCounter = 0;

// Initialize attributes on page load
document.addEventListener('DOMContentLoaded', function() {
    {% if message_type %}
        // Load existing attributes for editing
        {% for attr in message_type.attributes %}
            addAttribute(
                '{{ attr.name }}',
                '{{ attr.width or "" }}',
                {{ 'true' if attr.is_max_width else 'false' }},
                '{{ attr.description or "" }}',
                '{{ attr.default_value or "" }}',
                {{ 'true' if attr.is_computed else 'false' }},
                '{{ attr.computed_from or "" }}'
            );
        {% endfor %}
    {% else %}
        // Add default command attribute for new message types
        addAttribute('command', '1', false, 'Command identifier', '', false, '');
    {% endif %}
    
    // Initialize computed field states for existing attributes
    initializeComputedFields();
});

function addAttribute(name = '', width = '1', isMaxWidth = false, description = '', defaultValue = '', isComputed = false, computedFrom = '') {
    const container = document.getElementById('attributesContainer');
    const attributeRow = document.createElement('tr');
    attributeRow.className = 'attribute-row';
    attributeRow.id = `attribute-${attributeCounter}`;
    
    const isFirst = attributeCounter === 0;
    const isCommand = name === 'command' || (attributeCounter === 0 && !name);
    
    attributeRow.innerHTML = `
        <td>
            <input type="text" class="form-control form-control-sm" name="attribute_names" 
                   value="${name}" required ${isCommand ? 'readonly' : ''}>
        </td>
        <td>
            <input type="number" class="form-control form-control-sm" name="attribute_widths" 
                   value="${width}" min="1">
        </td>
        <td>
            <div class="form-check d-flex justify-content-center">
                <input class="form-check-input" type="checkbox" name="attribute_is_max_width_${attributeCounter}" 
                       value="true" ${isMaxWidth === true || isMaxWidth === 'true' ? 'checked' : ''}>
            </div>
        </td>
        <td>
            <input type="text" class="form-control form-control-sm" name="attribute_descriptions" 
                   value="${description}">
        </td>
        <td>
            <input type="text" class="form-control form-control-sm" name="attribute_default_values" 
                   value="${defaultValue}">
        </td>
        <td>
            <div class="form-check d-flex justify-content-center">
                <input class="form-check-input" type="checkbox" name="attribute_computed_${attributeCounter}" 
                       value="true" ${isComputed === true || isComputed === 'true' ? 'checked' : ''} onchange="toggleComputedField(${attributeCounter})">
            </div>
        </td>
        <td>
            <input type="text" class="form-control form-control-sm" name="attribute_computed_from_${attributeCounter}" 
                   value="${computedFrom}" 
                   style="display: ${isComputed === true || isComputed === 'true' ? 'table-cell' : 'none'};">
        </td>
        <td class="text-center">
            <div class="btn-group btn-group-sm">
                ${!isCommand ? `
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="moveAttribute(${attributeCounter}, -1)" title="Move Up">
                        <i class="fas fa-chevron-up"></i>
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="moveAttribute(${attributeCounter}, 1)" title="Move Down">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeAttribute(${attributeCounter})" title="Remove">
                        <i class="fas fa-trash"></i>
                    </button>
                ` : `
                    <span class="text-muted">-</span>
                `}
            </div>
        </td>
    `;
    
    container.appendChild(attributeRow);
    attributeCounter++;
}

function removeAttribute(index) {
    const element = document.getElementById(`attribute-${index}`);
    if (element) {
        element.remove();
    }
}

function moveAttribute(index, direction) {
    const container = document.getElementById('attributesContainer');
    const currentRow = document.getElementById(`attribute-${index}`);
    const allRows = container.querySelectorAll('.attribute-row');
    
    if (!currentRow) return;
    
    const currentIndex = Array.from(allRows).indexOf(currentRow);
    const newIndex = currentIndex + direction;
    
    // Check bounds
    if (newIndex < 0 || newIndex >= allRows.length) return;
    
    // Don't allow moving the command attribute (first row)
    if (currentIndex === 0 && direction < 0) return;
    
    // Don't allow moving other attributes above the command
    if (newIndex === 0 && currentIndex > 0) return;
    
    // Swap the rows
    if (direction < 0) {
        // Moving up
        container.insertBefore(currentRow, allRows[newIndex]);
    } else {
        // Moving down
        const nextRow = allRows[newIndex + 1];
        if (nextRow) {
            container.insertBefore(currentRow, nextRow);
        } else {
            container.appendChild(currentRow);
        }
    }
    
    // Update the IDs and onclick handlers for all rows
    updateRowIds();
}

function updateRowIds() {
    const container = document.getElementById('attributesContainer');
    const allRows = container.querySelectorAll('.attribute-row');
    
    allRows.forEach((row, newIndex) => {
        const oldId = row.id;
        const newId = `attribute-${newIndex}`;
        
        // Update the row ID
        row.id = newId;
        
        // Update all onclick handlers in the row
        const upButton = row.querySelector('button[onclick*="moveAttribute"]');
        const downButton = row.querySelector('button[onclick*="moveAttribute"]:nth-of-type(2)');
        const removeButton = row.querySelector('button[onclick*="removeAttribute"]');
        
        if (upButton) {
            upButton.onclick = () => moveAttribute(newIndex, -1);
        }
        if (downButton) {
            downButton.onclick = () => moveAttribute(newIndex, 1);
        }
        if (removeButton) {
            removeButton.onclick = () => removeAttribute(newIndex);
        }
        
        // Update computed field toggle
        const computedCheckbox = row.querySelector(`input[name="attribute_computed_${newIndex}"]`);
        if (computedCheckbox) {
            computedCheckbox.onchange = () => toggleComputedField(newIndex);
        }
    });
}

function toggleComputedField(index) {
    const row = document.getElementById(`attribute-${index}`);
    if (!row) {
        console.error(`Row with ID attribute-${index} not found`);
        return;
    }
    
    const computedFromField = row.querySelector(`input[name="attribute_computed_from_${index}"]`);
    const checkbox = row.querySelector(`input[name="attribute_computed_${index}"]`);
    
    if (!computedFromField || !checkbox) {
        console.error(`Required fields not found in row ${index}`);
        return;
    }
    
    if (checkbox.checked) {
        computedFromField.style.display = 'table-cell';
    } else {
        computedFromField.style.display = 'none';
        computedFromField.value = '';
    }
}

function initializeComputedFields() {
    const allRows = document.querySelectorAll('.attribute-row');
    allRows.forEach((row, index) => {
        const checkbox = row.querySelector(`input[name="attribute_computed_${index}"]`);
        const computedFromField = row.querySelector(`input[name="attribute_computed_from_${index}"]`);
        
        if (checkbox && computedFromField) {
            // Set initial display state based on checkbox
            computedFromField.style.display = checkbox.checked ? 'table-cell' : 'none';
        }
    });
}

// Form validation
document.getElementById('messageTypeForm').addEventListener('submit', function(e) {
    const attributes = document.querySelectorAll('.attribute-row');
    let hasError = false;
    
    // Check if we have at least one attribute
    if (attributes.length === 0) {
        alert('At least one attribute is required.');
        e.preventDefault();
        return;
    }
    
    // Validate each attribute
    attributes.forEach((attr, index) => {
        const name = attr.querySelector('input[name="attribute_names"]').value.trim();
        const width = attr.querySelector('input[name="attribute_widths"]').value.trim();
        const isMaxWidth = attr.querySelector(`input[name="attribute_is_max_width_${index}"]`).checked;
        const isComputed = attr.querySelector(`input[name="attribute_computed_${index}"]`).checked;
        const computedFrom = attr.querySelector(`input[name="attribute_computed_from_${index}"]`).value.trim();
        
        if (!name) {
            alert(`Attribute ${index + 1} must have a name.`);
            hasError = true;
            return;
        }
        
        if (!width && !isComputed) {
            alert(`Attribute "${name}" must have either a width or be computed.`);
            hasError = true;
            return;
        }
        
        if (isComputed && !computedFrom) {
            alert(`Computed attribute "${name}" must specify which attribute it's computed from.`);
            hasError = true;
            return;
        }
    });
    
    if (hasError) {
        e.preventDefault();
    }
});
</script>
{% endblock %}
